<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Audio Player</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Custom Styles (Scrollbar & Arabic Font) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        .font-arabic {
            font-family: 'Amiri', serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Mushaf Page Layout Styles */
        .mushaf-layout {
            text-align: justify;
            text-align-last: center;
            display: block;
        }

        /* Ruled paper effect for page mode - Exact Table-like Rows with massive separation */
        .ruled-page {
            /* Mobile Layout */
            font-size: 28px !important;
            line-height: 80px !important;
            background-image: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 78px,
                #a7f3d0 78px, /* emerald-200 line */
                #a7f3d0 80px
            ) !important;
            background-size: 100% 80px !important;
            background-attachment: local !important; /* Forces lines to scroll with text */
            padding-top: 10px; 
        }
        @media (min-width: 768px) {
            .ruled-page {
                /* Desktop Layout */
                font-size: 38px !important;
                line-height: 120px !important;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0px,
                    transparent 118px,
                    #a7f3d0 118px, /* emerald-200 line */
                    #a7f3d0 120px
                ) !important;
                background-size: 100% 120px !important;
                background-attachment: local !important; /* Forces lines to scroll with text */
                padding-top: 15px;
            }
        }

        /* Utility class for hiding elements */
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex h-screen bg-emerald-50 text-slate-800 font-sans overflow-hidden">

    <!-- Hidden Audio Element -->
    <audio id="audio-player"></audio>

    <!-- --- SIDEBAR (List) --- -->
    <aside id="sidebar" class="-translate-x-full md:translate-x-0 transition-transform duration-300 fixed md:static z-30 w-72 h-full bg-white shadow-xl flex flex-col">
        <div class="p-6 bg-emerald-700 text-white flex items-center justify-between shrink-0">
            <div class="flex items-center gap-3">
                <i data-lucide="book-open" class="text-emerald-200 w-7 h-7"></i>
                <h1 class="text-xl font-bold tracking-wide">Al Quran</h1>
            </div>
            <!-- Mobile close button -->
            <button class="md:hidden" id="btn-close-sidebar">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Tabs for Para / Surah -->
        <div class="flex bg-slate-100 p-1 m-4 rounded-lg shrink-0">
            <button id="tab-surah" class="flex-1 py-1.5 text-xs font-semibold rounded-md transition-all bg-white shadow text-emerald-700">
                Surah
            </button>
            <button id="tab-ayah" class="flex-1 py-1.5 text-xs font-semibold rounded-md transition-all text-slate-500 hover:text-emerald-600">
                Ayah
            </button>
            <button id="tab-page" class="flex-1 py-1.5 text-xs font-semibold rounded-md transition-all text-slate-500 hover:text-emerald-600">
                Page
            </button>
        </div>

        <!-- Search Bar -->
        <div class="px-4 pb-4 border-b border-emerald-100 shrink-0">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="Search Surah..." 
                    class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-sm"
                />
            </div>
        </div>

        <!-- List -->
        <div id="list-container" class="flex-1 overflow-y-auto custom-scrollbar">
            <!-- List items injected via JS -->
        </div>
    </aside>

    <!-- --- MAIN CONTENT AREA --- -->
    <main class="flex-1 flex flex-col relative w-full">
        
        <!-- Header (Dynamic visibility) -->
        <div id="top-header" class="md:hidden p-4 bg-emerald-700 text-white flex items-center shadow-md shrink-0 z-20 relative">
            <button id="btn-open-sidebar" class="p-2 -ml-2 rounded-lg hover:bg-emerald-600">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <h1 class="text-lg font-bold ml-2">Quran Audio Player</h1>
        </div>

        <!-- Center Display (Outer scroll hidden, handles flexible sizing) -->
        <div class="flex-1 flex flex-col items-center justify-start p-4 md:p-8 text-center bg-emerald-100/50 bg-[url('https://www.transparenttextures.com/patterns/arabesque.png')] overflow-hidden">
            
            <!-- The Mushaf "Page" Card (flex-1 to take up available height, min-h-0 required for internal scroll to work) -->
            <div class="bg-[#FCFBF4] bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')] p-6 md:p-10 rounded-sm shadow-[0_20px_50px_rgba(0,0,0,0.15)] border border-[#e5dfc5] max-w-5xl w-full flex flex-col flex-1 min-h-0 transition-all relative">
                
                <!-- Traditional Mushaf inner borders (z-20 keeps them on top of scrolling text) -->
                <div class="absolute inset-2 md:inset-4 border-2 border-emerald-900/10 pointer-events-none rounded-sm z-20"></div>
                <div class="absolute inset-3 md:inset-5 border border-emerald-900/10 pointer-events-none rounded-sm z-20"></div>
                
                <!-- Header info for currently playing -->
                <div id="mushaf-header" class="shrink-0 mb-6 flex flex-col items-center relative z-10 border-b border-emerald-900/10 pb-6 transition-all duration-300">
                    <p id="main-type" class="text-emerald-700 font-bold tracking-widest uppercase text-xs md:text-sm mb-2">
                        Currently Playing (Surah)
                    </p>
                    <h2 id="main-title" class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">
                        Surah 1
                    </h2>
                    <p id="main-subtitle" class="text-lg text-emerald-700 font-medium mb-4">
                        Al-Fatihah
                    </p>
                    
                    <!-- Play Button -->
                    <button id="main-play-btn" class="bg-emerald-700 text-white p-4 rounded-full shadow-lg hover:bg-emerald-800 hover:shadow-emerald-600/30 transition-all transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-emerald-200">
                        <i data-lucide="play" id="main-icon-play" class="w-7 h-7 ml-1"></i>
                        <i data-lucide="pause" id="main-icon-pause" class="w-7 h-7 hidden"></i>
                    </button>
                </div>

                <!-- Reading Area (Ayahs) (flex-1 and overflow-hidden let inner container scroll) -->
                <div id="reading-area" class="mt-2 text-right h-full relative z-10 flex flex-col flex-1 overflow-hidden" dir="rtl">
                    
                    <!-- Side Scroll Buttons -->
                    <div id="side-scroll-buttons" class="hidden absolute left-0 md:left-4 top-1/2 -translate-y-1/2 flex-col gap-3 z-30 transition-all duration-300">
                        <button id="btn-scroll-up" class="p-2.5 md:p-3 bg-emerald-800/10 text-emerald-800 hover:bg-emerald-800 hover:text-white rounded-full shadow-sm backdrop-blur-sm transition-all focus:outline-none border border-emerald-900/10">
                            <i data-lucide="chevron-up" class="w-5 h-5 md:w-6 md:h-6"></i>
                        </button>
                        <button id="btn-scroll-down" class="p-2.5 md:p-3 bg-emerald-800/10 text-emerald-800 hover:bg-emerald-800 hover:text-white rounded-full shadow-sm backdrop-blur-sm transition-all focus:outline-none border border-emerald-900/10">
                            <i data-lucide="chevron-down" class="w-5 h-5 md:w-6 md:h-6"></i>
                        </button>
                    </div>

                    <!-- Audio streaming state -->
                    <div id="audio-mode-msg" class="flex flex-col items-center justify-center text-slate-400 flex-1">
                        <div class="w-24 h-24 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <i data-lucide="book-open" class="text-emerald-200 w-12 h-12"></i>
                        </div>
                        <p>Audio streaming mode active.</p>
                        <p class="text-sm mt-2">Switch to "By Ayah" or "By Page" to read the Uthmani script.</p>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="hidden flex justify-center items-center flex-1">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-700"></div>
                    </div>

                    <!-- Arabic Text Container (The element that actually scrolls) -->
                    <div id="arabic-text-container" class="hidden mb-2 w-full flex-1 overflow-y-auto custom-scrollbar px-2 md:px-4">
                        <!-- Ayahs injected via JS -->
                    </div>

                    <!-- Page Navigation (Static/Sticky at bottom of reading area) -->
                    <div id="page-navigation" class="hidden justify-between items-center shrink-0 pt-4 border-t border-emerald-900/10 font-sans pb-2 px-2 md:px-4" dir="ltr">
                        <button id="btn-page-prev" class="px-5 py-2.5 bg-emerald-700/10 text-emerald-800 rounded-full hover:bg-emerald-700/20 transition-colors font-semibold text-sm flex items-center gap-2">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="page-indicator" class="text-emerald-800 font-bold tracking-wide"></span>
                        <button id="btn-page-next" class="px-6 py-2.5 bg-emerald-700 text-white rounded-full shadow-md hover:bg-emerald-800 transition-colors font-semibold text-sm flex items-center gap-2">
                            Next Page <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- --- BOTTOM AUDIO PLAYER BAR --- -->
        <div id="bottom-player-bar" class="bg-white border-t border-emerald-100 p-4 md:p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-10 w-full shrink-0 transition-all duration-300">
            <div class="max-w-4xl mx-auto">
                
                <!-- Progress Bar -->
                <div class="flex items-center gap-4 mb-4">
                    <span id="time-current" class="text-xs font-medium text-slate-500 w-10 text-right">00:00</span>
                    <input 
                        type="range" 
                        id="progress-slider"
                        min="0" 
                        max="100" 
                        value="0" 
                        class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600"
                    />
                    <span id="time-total" class="text-xs font-medium text-slate-500 w-10">00:00</span>
                </div>

                <!-- Controls -->
                <div class="flex items-center justify-between">
                    
                    <!-- Track Info (Bottom left) -->
                    <div class="hidden md:flex items-center gap-3 w-1/3">
                        <div class="bg-emerald-100 p-2 rounded-lg shrink-0">
                            <i data-lucide="book-open" class="text-emerald-700 w-5 h-5"></i>
                        </div>
                        <div class="truncate">
                            <h3 id="bottom-title" class="font-semibold text-slate-800 text-sm leading-tight">Surah 1</h3>
                            <p id="bottom-subtitle" class="text-xs text-slate-500 truncate">Al-Fatihah</p>
                        </div>
                    </div>

                    <!-- Main Media Controls (Center) -->
                    <div class="flex items-center justify-center gap-6 w-full md:w-1/3">
                        <button id="btn-prev" class="text-slate-400 hover:text-emerald-600 transition-colors focus:outline-none">
                            <i data-lucide="skip-back" class="w-6 h-6"></i>
                        </button>
                        
                        <button id="btn-play" class="bg-emerald-100 text-emerald-700 p-3 rounded-full hover:bg-emerald-200 hover:scale-105 transition-all focus:outline-none">
                            <i data-lucide="play" id="bottom-icon-play" class="w-6 h-6 ml-0.5"></i>
                            <i data-lucide="pause" id="bottom-icon-pause" class="w-6 h-6 hidden"></i>
                        </button>
                        
                        <button id="btn-next" class="text-slate-400 hover:text-emerald-600 transition-colors focus:outline-none">
                            <i data-lucide="skip-forward" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Volume Control (Bottom right) -->
                    <div class="hidden md:flex items-center justify-end gap-3 w-1/3">
                        <button id="btn-mute" class="text-slate-400 hover:text-emerald-600 transition-colors">
                            <i data-lucide="volume-2" id="icon-vol-up" class="w-5 h-5"></i>
                            <i data-lucide="volume-x" id="icon-vol-muted" class="w-5 h-5 hidden"></i>
                        </button>
                        <input 
                            type="range" 
                            id="volume-slider"
                            min="0" 
                            max="1" 
                            step="0.01" 
                            value="1" 
                            class="w-24 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600"
                        />
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Mobile overlay for sidebar -->
    <div id="sidebar-overlay" class="hidden z-20 fixed inset-0 bg-black/50"></div>

    <!-- Application Logic -->
    <script>
        // ------------------------------------------------------------------------
        // INSTRUCTION FOR YOUR LOCAL FILES:
        // Change `USE_LOCAL_FILES` to true when you host this with your own files.
        // Make sure your audio files are named 001.mp3, 002.mp3 ... up to 6236.mp3
        // and place them in an 'audio' folder next to this html file.
        // ------------------------------------------------------------------------
        const USE_LOCAL_FILES = false; 

        // Data (Total 6236 Ayahs in the Quran)
        const AYAHS = Array.from({length: 6236}, (_, i) => "Ayah " + (i + 1));
        const PAGES = Array.from({length: 604}, (_, i) => "Page " + (i + 1));

        const SURAHS = [
            "Al-Fatihah", "Al-Baqarah", "Ali 'Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
            "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Taha",
            "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum",
            "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
            "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
            "Ad-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
            "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
            "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "'Abasa",
            "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
            "Ash-Shams", "Al-Lail", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat",
            "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraish", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
            "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
        ];

        // State
        let state = {
            currentIndex: 0,
            playingType: 'surah', // 'surah' | 'ayah' | 'page'
            viewTab: 'surah',     // 'surah' | 'ayah' | 'page'
            isPlaying: false,
            searchQuery: "",
            isSidebarOpen: false,
            volume: 1,
            isMuted: false
        };

        // DOM Elements
        const audio = document.getElementById('audio-player');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const listContainer = document.getElementById('list-container');
        const searchInput = document.getElementById('search-input');
        const topHeader = document.getElementById('top-header');
        
        // Tabs
        const tabSurah = document.getElementById('tab-surah');
        const tabAyah = document.getElementById('tab-ayah');
        const tabPage = document.getElementById('tab-page');
        
        // Reading Area Elements
        const audioModeMsg = document.getElementById('audio-mode-msg');
        const loadingSpinner = document.getElementById('loading-spinner');
        const arabicTextContainer = document.getElementById('arabic-text-container');
        const sideScrollButtons = document.getElementById('side-scroll-buttons');
        
        // Progress & Volume
        const progressSlider = document.getElementById('progress-slider');
        const timeCurrent = document.getElementById('time-current');
        const timeTotal = document.getElementById('time-total');
        const volumeSlider = document.getElementById('volume-slider');

        // Initialize Lucide Icons
        lucide.createIcons();

        // ------------------------------------------------------------------------
        // BOOKMARK / AUTO-SAVE LOGIC
        // ------------------------------------------------------------------------
        function saveBookmark() {
            localStorage.setItem('quran_app_bookmark', JSON.stringify({
                playingType: state.playingType,
                currentIndex: state.currentIndex
            }));
        }

        function loadBookmark() {
            const saved = localStorage.getItem('quran_app_bookmark');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.playingType && parsed.currentIndex !== undefined) {
                        state.playingType = parsed.playingType;
                        state.currentIndex = parsed.currentIndex;
                        state.viewTab = parsed.playingType; // Align the tab view to the saved reading mode
                    }
                } catch (e) {
                    console.error("Failed to load bookmark", e);
                }
            }
        }

        // ------------------------------------------------------------------------
        // HELPER FUNCTIONS
        // ------------------------------------------------------------------------
        const padZero = (num) => String(num).padStart(3, '0');

        const formatTime = (time) => {
            if (isNaN(time)) return "00:00";
            const mins = Math.floor(time / 60);
            const secs = Math.floor(time % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        };

        const getAudioSource = (type, index) => {
            if (type === 'surah') {
                return `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${index + 1}.mp3`;
            } else {
                const fileNumber = padZero(index + 1);
                if (USE_LOCAL_FILES) {
                    return `/audio/${fileNumber}.mp3`;
                }
                // Directly streams from the Ayah audio CDN
                return `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${index + 1}.mp3`; 
            }
        };

        // ------------------------------------------------------------------------
        // UI RENDERING
        // ------------------------------------------------------------------------
        function renderSidebar() {
            let activeList;
            if (state.viewTab === 'ayah') activeList = AYAHS;
            else if (state.viewTab === 'page') activeList = PAGES;
            else activeList = SURAHS;
            
            const query = state.searchQuery.toLowerCase();
            
            const filteredItems = activeList
                .map((name, index) => ({ name, index }))
                .filter(item => 
                    item.name.toLowerCase().includes(query) ||
                    (item.index + 1).toString().includes(query)
                );

            listContainer.innerHTML = '';

            if (filteredItems.length === 0) {
                listContainer.innerHTML = `<div class="p-6 text-center text-slate-500 text-sm">No items found.</div>`;
                return;
            }

            // Cap items to 150 to prevent 6236 DOM nodes from lagging the browser
            const itemsToRender = filteredItems.slice(0, 150);

            itemsToRender.forEach(item => {
                const isPlayingItem = (state.playingType === state.viewTab && state.currentIndex === item.index);
                
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-6 py-4 border-b border-slate-50 hover:bg-emerald-50 transition-colors flex items-center justify-between group ${isPlayingItem ? 'bg-emerald-100 border-l-4 border-l-emerald-600' : 'border-l-4 border-l-transparent'}`;
                
                // Content
                let innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-semibold w-8 h-8 flex items-center justify-center rounded-full shrink-0 ${isPlayingItem ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-500 group-hover:bg-emerald-200 group-hover:text-emerald-700'}">
                            ${item.index + 1}
                        </span>
                        <span class="font-medium text-sm ${isPlayingItem ? 'text-emerald-800' : 'text-slate-700'}">
                            ${item.name}
                        </span>
                    </div>`;

                // Add playing animation bars if active and not in page mode (since page mode pauses audio)
                if (isPlayingItem && state.isPlaying && state.playingType !== 'page') {
                    innerHTML += `
                        <div class="flex gap-1 items-end h-4 shrink-0">
                            <div class="w-1 h-2 bg-emerald-500 animate-[pulse_1s_ease-in-out_infinite] rounded-t"></div>
                            <div class="w-1 h-4 bg-emerald-500 animate-[pulse_1s_ease-in-out_infinite_100ms] rounded-t"></div>
                            <div class="w-1 h-3 bg-emerald-500 animate-[pulse_1s_ease-in-out_infinite_200ms] rounded-t"></div>
                        </div>`;
                }

                btn.innerHTML = innerHTML;
                btn.onclick = () => playTrack(state.viewTab, item.index);
                listContainer.appendChild(btn);
            });

            // Note for users if search yields too many results
            if (filteredItems.length > 150) {
                const note = document.createElement('div');
                note.className = "p-4 text-center text-xs text-slate-400";
                note.innerText = `Showing 150 of ${filteredItems.length} results. Use search to narrow down.`;
                listContainer.appendChild(note);
            }
        }

        function updateMainDisplay() {
            let name, num, typeLabel;
            if (state.playingType === 'ayah') {
                name = AYAHS[state.currentIndex]; num = state.currentIndex + 1; typeLabel = 'Ayah';
            } else if (state.playingType === 'page') {
                name = PAGES[state.currentIndex]; num = state.currentIndex + 1; typeLabel = 'Page';
            } else {
                name = SURAHS[state.currentIndex]; num = state.currentIndex + 1; typeLabel = 'Surah';
            }

            const mushafHeader = document.getElementById('mushaf-header');
            const bottomPlayerBar = document.getElementById('bottom-player-bar');
            const pageNavigation = document.getElementById('page-navigation');
            const pageIndicator = document.getElementById('page-indicator');

            // --- FULL SCREEN PAGE MODE ---
            // Hide headers/audio players when in Page mode, collapse sidebar fully
            if (state.playingType === 'page') {
                mushafHeader.classList.add('hidden');
                bottomPlayerBar.classList.add('hidden');
                
                pageNavigation.classList.remove('hidden');
                pageNavigation.classList.add('flex');
                pageIndicator.innerText = `Page ${num}`;
                
                sideScrollButtons.classList.remove('hidden');
                sideScrollButtons.classList.add('flex');

                // Turn Sidebar into a sliding drawer on ALL screen sizes (Full screen layout)
                sidebar.classList.remove('md:translate-x-0', 'md:static');
                topHeader.classList.remove('md:hidden');
            } else {
            // --- STANDARD MODE ---
                mushafHeader.classList.remove('hidden');
                bottomPlayerBar.classList.remove('hidden');
                
                pageNavigation.classList.add('hidden');
                pageNavigation.classList.remove('flex');
                
                sideScrollButtons.classList.add('hidden');
                sideScrollButtons.classList.remove('flex');

                // Restore sidebar fixed presence on Desktop
                sidebar.classList.add('md:translate-x-0', 'md:static');
                topHeader.classList.add('md:hidden');

                // Main display texts (Only needed when visible)
                document.getElementById('main-type').innerText = `Currently Viewing (${typeLabel})`;
                document.getElementById('main-title').innerText = `${typeLabel} ${num}`;
                document.getElementById('main-subtitle').innerText = name;
                
                // Bottom bar texts
                document.getElementById('bottom-title').innerText = `${typeLabel} ${num}`;
                document.getElementById('bottom-subtitle').innerText = name;
            }

            // Update Play/Pause Icons
            const mPlay = document.getElementById('main-icon-play');
            const mPause = document.getElementById('main-icon-pause');
            const bPlay = document.getElementById('bottom-icon-play');
            const bPause = document.getElementById('bottom-icon-pause');
            
            const mainPlayBtn = document.getElementById('main-play-btn');
            const bottomPlayBtn = document.getElementById('btn-play');

            // Visual feedback for disabled play button in Page mode
            if (state.playingType === 'page') {
                mainPlayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                bottomPlayBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                mainPlayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                bottomPlayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            if (state.isPlaying) {
                mPlay.classList.add('hidden'); mPause.classList.remove('hidden');
                bPlay.classList.add('hidden'); bPause.classList.remove('hidden');
            } else {
                mPlay.classList.remove('hidden'); mPause.classList.add('hidden');
                bPlay.classList.remove('hidden'); bPause.classList.add('hidden');
            }
        }

        function updateSidebarVisibility() {
            if (state.isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        function updateTabStyles() {
            const label = state.viewTab.charAt(0).toUpperCase() + state.viewTab.slice(1);
            searchInput.placeholder = `Search ${label}...`;
            
            // Reset all tabs
            tabSurah.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all text-slate-500 hover:text-emerald-600";
            tabAyah.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all text-slate-500 hover:text-emerald-600";
            tabPage.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all text-slate-500 hover:text-emerald-600";

            // Highlight active
            if (state.viewTab === 'surah') {
                tabSurah.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all bg-white shadow text-emerald-700";
            } else if (state.viewTab === 'ayah') {
                tabAyah.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all bg-white shadow text-emerald-700";
            } else {
                tabPage.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all bg-white shadow text-emerald-700";
            }
        }

        // ------------------------------------------------------------------------
        // API (FETCH TEXT)
        // ------------------------------------------------------------------------
        async function fetchTextData() {
            if (state.playingType === 'surah') {
                audioModeMsg.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                arabicTextContainer.classList.add('hidden');
                return;
            }

            // Show loading
            audioModeMsg.classList.add('hidden');
            arabicTextContainer.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                let url = state.playingType === 'ayah' 
                    ? `https://api.alquran.cloud/v1/ayah/${state.currentIndex + 1}/quran-uthmani`
                    : `https://api.alquran.cloud/v1/page/${state.currentIndex + 1}/quran-uthmani`;

                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    if (state.playingType === 'ayah') {
                        // Single Ayah Mode - flex-1 enables scroll inside the container
                        arabicTextContainer.className = "leading-[4.5rem] md:leading-[6.5rem] text-slate-900 text-3xl md:text-4xl font-arabic w-full flex-1 overflow-y-auto custom-scrollbar px-2 md:px-4 pb-12";
                        
                        const ayah = data.data;
                        let htmlContent = `
                            <span class="inline">
                                ${ayah.text} 
                                <span class="text-emerald-700 text-base md:text-xl mx-2 font-sans inline-flex items-center justify-center w-8 h-8 rounded-full bg-emerald-900/5 border border-emerald-900/20">
                                    ${ayah.numberInSurah}
                                </span>
                            </span>
                            <div class="text-sm text-slate-500 mt-6 font-sans text-center border-t border-emerald-900/10 pt-4">
                                Surah ${ayah.surah.englishName} (${ayah.surah.name}) - Ayah ${ayah.numberInSurah}
                            </div>`;
                        arabicTextContainer.innerHTML = htmlContent;

                        document.getElementById('main-subtitle').innerText = `Surah ${ayah.surah.englishName}, Ayah ${ayah.numberInSurah}`;
                        document.getElementById('bottom-subtitle').innerText = `Surah ${ayah.surah.englishName}, Ayah ${ayah.numberInSurah}`;
                    } else if (state.playingType === 'page') {
                        // Page Mode - flex-1 enables internal scroll, ruled-page applies the lines
                        arabicTextContainer.className = "mushaf-layout ruled-page text-slate-900 font-arabic w-full flex-1 overflow-y-auto custom-scrollbar px-2 md:px-6 pb-12";
                        
                        const ayahs = data.data.ayahs;
                        
                        // Map all ayahs naturally so words stay close, but the CSS forces huge line heights
                        let htmlContent = ayahs.map(ayah => `
                            <span class="inline">
                                ${ayah.text} 
                                <span class="text-emerald-700 text-sm md:text-lg mx-1.5 font-sans inline-flex items-center justify-center w-6 h-6 md:w-8 md:h-8 rounded-full bg-emerald-900/5 border border-emerald-900/20">
                                    ${ayah.numberInSurah}
                                </span>
                            </span>
                        `).join(' ');

                        // Add Surah footer, safely resetting its style so it isn't affected by the massive line-height rules above
                        const surahsOnPage = [...new Set(ayahs.map(a => a.surah.englishName))].join(', ');
                        htmlContent += `
                            <div class="text-sm text-slate-500 mt-10 font-sans text-center border-t border-emerald-900/10 pt-4" style="line-height: 1.5 !important; font-size: 16px !important; text-align-last: center; background: #FCFBF4;">
                                Surahs on this page: ${surahsOnPage}
                            </div>`;

                        arabicTextContainer.innerHTML = htmlContent;
                        // Scroll top on new page load
                        arabicTextContainer.scrollTop = 0;
                    }
                }
            } catch (err) {
                console.error("Failed to fetch text:", err);
                arabicTextContainer.innerHTML = '<p class="text-center text-lg mt-10">Failed to load text. Please check your connection.</p>';
            } finally {
                loadingSpinner.classList.add('hidden');
                arabicTextContainer.classList.remove('hidden');
            }
        }

        // ------------------------------------------------------------------------
        // ACTIONS & LOGIC
        // ------------------------------------------------------------------------
        function togglePlay() {
            if (state.playingType === 'page') return; // Audio playback disabled in page reading mode
            
            if (state.isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
            state.isPlaying = !state.isPlaying;
            updateMainDisplay();
            renderSidebar(); // Update animated bars
        }

        function playTrack(type, index) {
            const typeChanged = state.playingType !== type;
            const indexChanged = state.currentIndex !== index;

            state.playingType = type;
            state.currentIndex = index;
            state.isSidebarOpen = false;
            
            // Automatically save user's current track/page as bookmark
            saveBookmark();

            if (type === 'page') {
                // Pause audio when switching to reading full pages
                audio.pause();
                state.isPlaying = false;
                audio.src = "";
                progressSlider.value = 0;
                timeCurrent.innerText = "00:00";
                timeTotal.innerText = "00:00";
            } else {
                state.isPlaying = true;
                audio.src = getAudioSource(type, index);
                audio.play();
            }

            updateSidebarVisibility();
            updateMainDisplay();
            renderSidebar();

            if (typeChanged || indexChanged) {
                fetchTextData();
            }
        }

        function nextTrack() {
            let maxList;
            if (state.playingType === 'ayah') maxList = AYAHS;
            else if (state.playingType === 'page') maxList = PAGES;
            else maxList = SURAHS;

            if (state.currentIndex < maxList.length - 1) {
                playTrack(state.playingType, state.currentIndex + 1);
            }
        }

        function prevTrack() {
            if (state.currentIndex > 0) {
                playTrack(state.playingType, state.currentIndex - 1);
            }
        }

        function toggleMute() {
            const vUp = document.getElementById('icon-vol-up');
            const vMute = document.getElementById('icon-vol-muted');

            if (state.isMuted) {
                audio.volume = state.volume || 1;
                state.isMuted = false;
                volumeSlider.value = audio.volume;
                vUp.classList.remove('hidden'); vMute.classList.add('hidden');
            } else {
                audio.volume = 0;
                state.isMuted = true;
                volumeSlider.value = 0;
                vUp.classList.add('hidden'); vMute.classList.remove('hidden');
            }
        }

        // ------------------------------------------------------------------------
        // EVENT LISTENERS
        // ------------------------------------------------------------------------
        
        // Scroll Button Actions
        document.getElementById('btn-scroll-up').onclick = () => {
            const scrollAmount = arabicTextContainer.clientHeight * 0.6; // Scroll up by 60% of visible area
            arabicTextContainer.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
        };
        
        document.getElementById('btn-scroll-down').onclick = () => {
            const scrollAmount = arabicTextContainer.clientHeight * 0.6; // Scroll down by 60% of visible area
            arabicTextContainer.scrollBy({ top: scrollAmount, behavior: 'smooth' });
        };

        // Audio Events
        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                progressSlider.value = audio.currentTime;
                timeCurrent.innerText = formatTime(audio.currentTime);
            }
        });

        audio.addEventListener('loadedmetadata', () => {
            progressSlider.max = audio.duration;
            timeTotal.innerText = formatTime(audio.duration);
        });

        audio.addEventListener('ended', nextTrack);

        // UI Interactions
        document.getElementById('main-play-btn').onclick = togglePlay;
        document.getElementById('btn-play').onclick = togglePlay;
        document.getElementById('btn-next').onclick = nextTrack;
        document.getElementById('btn-prev').onclick = prevTrack;
        document.getElementById('btn-mute').onclick = toggleMute;
        
        // Page mode navigation buttons
        document.getElementById('btn-page-next').onclick = nextTrack;
        document.getElementById('btn-page-prev').onclick = prevTrack;

        progressSlider.addEventListener('input', (e) => {
            audio.currentTime = e.target.value;
        });

        volumeSlider.addEventListener('input', (e) => {
            const val = Number(e.target.value);
            audio.volume = val;
            state.volume = val;
            state.isMuted = val === 0;

            const vUp = document.getElementById('icon-vol-up');
            const vMute = document.getElementById('icon-vol-muted');
            if (state.isMuted) {
                vUp.classList.add('hidden'); vMute.classList.remove('hidden');
            } else {
                vUp.classList.remove('hidden'); vMute.classList.add('hidden');
            }
        });

        // Tabs
        tabSurah.onclick = () => {
            state.viewTab = 'surah';
            updateTabStyles();
            renderSidebar();
        };

        tabAyah.onclick = () => {
            state.viewTab = 'ayah';
            updateTabStyles();
            renderSidebar();
        };

        tabPage.onclick = () => {
            state.viewTab = 'page';
            updateTabStyles();
            renderSidebar();
        };

        // Search
        searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderSidebar();
        });

        // Sidebar Mobile Toggle
        document.getElementById('btn-open-sidebar').onclick = () => {
            state.isSidebarOpen = true;
            updateSidebarVisibility();
        };

        document.getElementById('btn-close-sidebar').onclick = () => {
            state.isSidebarOpen = false;
            updateSidebarVisibility();
        };

        sidebarOverlay.onclick = () => {
            state.isSidebarOpen = false;
            updateSidebarVisibility();
        };

        // ------------------------------------------------------------------------
        // INITIALIZATION
        // ------------------------------------------------------------------------
        // Step 1: Load Bookmark to restore user's previous reading place
        loadBookmark(); 
        
        // Step 2: Initialize UI and Audio based on loaded state
        audio.src = getAudioSource(state.playingType, state.currentIndex);
        updateTabStyles();
        updateMainDisplay();
        renderSidebar();
        fetchTextData();

    </script>
</body>
</html>